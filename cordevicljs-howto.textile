h1. Use Enterlab Rente to create a Cordova backed native app for Android and iOS using OnsenUI for user interface, Facebook React wrapped in ClojureScript Reagent using AJAX for logging on to a remote server and websocket via Sente for app/server communication

(Wheew!)

h2. Clone Enterlab Rente

# git clone https://github.com/enterlab/rente.git [your-app]

# cd [your-app]

# rm app.json

h2. Change namespaces and prepare for Cordova

# Replace all instances of "rente" in the project with [your-app]; cljs, clj and project.clj

# Change project.clj "dev-resources/www/js/out" to "resources/www/js/out"

# Change project.clj occurrences of "public" to "www", including :main, :output-to, :output-dir, :http-server-root, :css-dirs

# Rename folder src/rente to src/[your-app]

h2. Build ClojureScript

# Build with lein clean && lein figwheel

When no build error, continue:

# CTRL+c to stop figwheel

h2. Add Cordova

# rm -rf resources

# cordova create resources [com.yourcompany.your-app] "Your app description"

# cordova platform add browser

# cordova platform add ios
## add other platforms: android, wp8 etc. if you want

# cordova plugin add cordova-plugin-device

# cordova plugin add org.apache.cordova.dialogs

h2. Run Cordova sample app

# cd .. && lein clean && lein figwheel

In a new terminal tab (or window):

# lein run

This starts the server which respond to AJAX/socket connections

In yet another terminal tab/window:

# cd resources

# cordova prepare && cordova run browser

You should now see an Apache Cordova logo/text and a green box with the text "DEVICE IS READY" in your browser

# cordova run ios

You should now see the same, but this time in your iOS Emulator

h2. Convert for "Rente" (CLJS, React, websocket)

# edit www/index.html:
## change last <script/> tag from referencing js/index.js to js/app.js
## Add this in the bottom of the <head/> tag:   <!-- DEV ONLY! REMOVE IN PROD -->
  <script type="text/javascript" src="js/out/goog/base.js"></script>
## Add this just before the <body/> tag:
<!-- DEV ONLY! REPLACE IN PROD -->
<script type="text/javascript">
  goog.require("meewee.mobile.start");
</script>

# Add 'unsafe-inline' in the meta tag containing the Content-Security-Policy. It should be put just after "default-src 'self'" and just before "data:"

# In the end of the value of the tag, just after "media-src '*', add "; connect-src 'self' ws://localhost:8080 ws://localhost:3449;"

# In index.html add id="app" to the div element with class="app"

h2. Test "Rente" features (React and Socket)

# In resources folder: cordova run browser

See that the "APACHE CORDOVA" and the "DEVICE READY" has been replaced with content similar to that from Enterlab Rente.

This is rendered using React (via Reagent), which means that Reagent is rendering correctly.

If you open up your browser console, you should see that the app web socket has been connected as well, with a console log line such as:

Channel socket state change: {:type :ws, :open? true, :destroyed? false, :uid :taoensso.sente/nil-uid, :csrf-token nil, :first-open? true}

When you click the two buttons you will get the following console log results respectively:

CALLBACK from server:  [:cordevicljs/testevent {:message "Hello socket from server Callback, received: {:message \"Hello socket Callback!\"}"}]

and:
PUSHed :cordevicljs/testevent from server: {:message "Hello socket from server Event (no callback), received: {:message \"Hello socket Event!\"}"} 

h2. Add Device Native Interop

# Add the following two functions in app.cljs, just above the main function:

(defn ^:export onDeviceReady []  
  (-> (js* "navigator")
    (.-notification)
      (.alert "Device Native Bridge works!"
      (fn [] nil)
      ""
      "")))

(defn ^:export prepare-device []
  (.addEventListener js/document "deviceready" onDeviceReady true))

# Then add a call to (prepare-device) as the first line in the main function

h2. Test Device Native Interop

# One more: cordova run browser

You should now see a standard javascript alert showing that "Device Native Bridge works!"

Let's test it on the device as well:

# cordova run ios

If you get an alert in the native app that looks like a native alert showing the exact same text, "Device Native Bridge works!", then you're good to go - you've got the native device bridge working, so you can communicate with most native device features via Cordova! w00t!

Now is a good time for a walk in the park with a great cup of coffee and perhaps a good friend/colleage etc.

github tag: cljs-react-socket-device

h2. Add Angular.js

# Add language="en" ng-app="app" attributes to index.html's <html/> element

# Add <script src="lib/onsen/js/angular/angular.js"></script> to bottom of index.html <head/> element

# In top of app.cljs main function (before call to prepare-device), add this angular initialization:
(.module (.-angular js/window) "app" #js [])

# test in browser with cordova run browser

If you get the alert as usual, and reagent renders the Rente like content, it works.

# test in device like cordova run ios

If you get the alert there as well, you're good to go on! :)

github tag: cljs-react-socket-device-angular

h2. Add OnsenUI



